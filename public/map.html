<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8"/>
    <title>KiezTransit â€“ Linienkarte</title>

    <!-- Leaflet CSS -->
    <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
            integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
            crossorigin=""
    />

    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            background: #111;
        }

        #map {
            width: 100vw;
            height: 100vh;
        }

        .stop-label {
            font-size: 11px;
            color: #222;
            background: rgba(255, 255, 255, 0.85);
            border: none;
            box-shadow: none;
            padding: 1px 4px;
        }

        .leaflet-control-attribution {
            font-size: 9px;
        }

        .map-title {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(17, 17, 17, 0.7);
            color: #f5f5f5;
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
<div class="map-title">KiezTransit Â· Linien</div>
<div id="map"></div>

<!-- Leaflet JS -->
<script
        src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""
></script>

<script>
    const map = L.map('map', {
        zoomControl: true
    });

    // Minimalistische Stadia-Map
    L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_smooth/{z}/{x}/{y}{r}.png', {
        maxZoom: 19
    }).addTo(map);

    const allLatLngs = [];

    function drawLine(lineEntry, lineData) {
        const color = lineData.color || lineEntry.color || "#d81e05";

        const shape = lineData.shape || {};
        const type = shape.type || "LineString";
        const coords = shape.coordinates || [];

        const polyStyle = {
            color: color,
            weight: 3,
            opacity: 1
        };

        // ðŸ”¹ MultiLineString â†’ mehrere Segmente
        if (type === "MultiLineString") {
            coords.forEach(segment => {
                const segLatLngs = segment.map(c => L.latLng(c[0], c[1]));
                if (segLatLngs.length > 1) {
                    L.polyline(segLatLngs, polyStyle).addTo(map);
                    allLatLngs.push(...segLatLngs);
                }
            });
        }

        // ðŸ”¹ LineString â†’ einfache Liste [[lat, lon], ...]
        else if (type === "LineString") {
            const latlngs = coords.map(c => L.latLng(c[0], c[1]));
            if (latlngs.length > 1) {
                L.polyline(latlngs, polyStyle).addTo(map);
                allLatLngs.push(...latlngs);
            }
        }

        // Stops einzeichnen
        (lineData.stops || []).forEach(stop => {
            if (typeof stop.lat !== "number" || typeof stop.lon !== "number") return;

            const latlng = L.latLng(stop.lat, stop.lon);

            const marker = L.circleMarker(latlng, {
                radius: 4,
                color: color,
                weight: 2,
                fillColor: "#ffffff",
                fillOpacity: 1
            }).addTo(map);

            marker.bindTooltip(stop.name, {
                permanent: true,
                direction: "right",
                offset: [8, 0],
                className: "stop-label"
            });

            allLatLngs.push(latlng);
        });
    }

    // Daten laden
    fetch('data/lines.json')
        .then(res => res.json())
        .then(index => {
            const lines = index.lines || [];
            if (!lines.length) {
                console.error("Keine Linien in data/lines.json gefunden");
                return;
            }

            const fetches = lines.map(line =>
                fetch(`data/${line.id}.line.json`)
                    .then(res => res.json())
                    .then(data => ({entry: line, data}))
                    .catch(err => {
                        console.error(`Fehler beim Laden von ${line.id}.line.json:`, err);
                        return null;
                    })
            );

            return Promise.all(fetches);
        })
        .then(results => {
            if (!results) return;

            results
                .filter(r => r !== null)
                .forEach(({entry, data}) => drawLine(entry, data));

            if (allLatLngs.length > 0) {
                const bounds = L.latLngBounds(allLatLngs);
                map.fitBounds(bounds, {padding: [40, 40]});
            } else {
                map.setView([52.52, 13.405], 12);
            }
        })
        .catch(err => {
            console.error("Fehler beim Initialisieren der Map:", err);
            map.setView([52.52, 13.405], 12);
        });
</script>
</body>
</html>